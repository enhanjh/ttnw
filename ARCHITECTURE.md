# 시스템 아키텍처

## 1. 개요

본 문서는 사용자가 정의한 투자 전략의 백테스팅 및 자동화된 실거래를 지원하는 시스템의 아키텍처를 정의합니다.

핵심 설계 목표는 다음과 같습니다.
- **안정성**: 웹 서비스와 거래 엔진을 분리하여, 어느 한쪽의 장애가 다른 쪽에 영향을 주지 않도록 합니다.
- **확장성**: 백테스팅, 실거래, 웹 서비스 등 각 컴포넌트의 부하에 따라 독립적으로 확장할 수 있는 구조를 지향합니다.
- **일관성**: 백테스팅과 실거래에서 동일한 전략 로직이 사용되도록 보장하여, 백테스트 결과의 신뢰도를 극대화합니다.
- **유지보수성**: 각 컴포넌트의 역할을 명확히 분리하고, 핵심 로직을 추상화하여 코드의 중복을 제거하고 유지보수를 용이하게 합니다.

## 2. 핵심 컴포넌트

시스템은 역할에 따라 명확히 분리된 여러 컴포넌트로 구성됩니다. 이들 간의 통신은 메시지 큐(Message Queue)를 통해 비동기적으로 이루어집니다.

![High Level Architecture](https://i.imgur.com/9z8aE6B.png)

### 2.1. 웹 서비스 (Web Service / API Server)
- **역할**: 전략 관리 및 모니터링 대시보드
- **주요 기능**:
    - 사용자를 위한 UI/API 제공
    - 투자 전략 생성, 조회, 수정, 삭제 (CRUD)
    - 백테스트 실행 요청 (작업을 메시지 큐에 전달)
    - 전략 활성화/비활성화 상태 변경 (명령을 메시지 큐에 전달)
    - 백테스트 결과 및 실거래 운용 현황 시각화

### 2.2. 메시지 큐 (Message Queue)
- **역할**: 중앙 제어 및 명령 채널 (Task Broker)
- **주요 기능**:
    - 웹 서비스, 스케줄러, 워커 간의 통신을 중재하는 비동기 메시지 브로커
    - 각 컴포넌트 간의 의존성을 제거(Decoupling)하여 시스템의 유연성과 안정성을 확보
    - **기술 스택**: `Redis` 또는 `RabbitMQ`

### 2.3. 스케줄러 (Scheduler / Beat)
- **역할**: 주기적인 작업 지시자
- **주요 기능**:
    - 아주 가벼운 독립 프로세스로, 정해진 시간 간격(예: 매 분)마다 작업 지시 메시지를 메시지 큐에 전송
    - 직접 작업을 수행하지 않고, 단지 "실행 시간"을 알리는 역할만 수행
    - **기술 스택**: `Celery Beat`

### 2.4. 백테스팅 워커 (Backtesting Worker)
- **역할**: 온디맨드(On-demand) 백테스트 분석 엔진
- **주요 기능**:
    - 메시지 큐에 "백테스트 실행" 작업이 들어오면 이를 가져와 처리
    - `BacktestExecutor`를 사용하여 과거 데이터 기반으로 전략 시뮬레이션 수행
    - 완료된 결과(수익률, 거래내역 등)를 데이터베이스에 저장
    - **기술 스택**: `Celery Worker`

### 2.5. 실거래 워커 풀 (Live Trading Worker Pool)
- **역할**: 독립적인 자동 거래 봇
- **주요 기능**:
    - 여러 개의 워커가 풀(Pool)을 이루어 메시지 큐를 감시
    - 스케줄러가 전달한 "전략 평가" 작업을 병렬적으로 가져와 동시에 처리
    - `LiveExecutor`를 사용하여 실시간 데이터 기반으로 전략을 평가하고, 거래 신호 발생 시 실제 주문 실행
    - 모든 거래 및 성과를 데이터베이스에 기록
    - **기술 스택**: `Celery Worker`

## 3. 핵심 로직 추상화: Strategy / DataContext / Executor

백테스팅과 실거래 로직의 일관성을 보장하기 위해, 전략의 핵심 로직을 외부 환경(데이터, 실행 방식)과 분리합니다.

```
                               +-----------------+
                               | Strategy Logic  |  (✨ 공통 핵심 코드)
                               | (신호 생성)     |
                               +-----------------+
                                       ^
                                       |
                                       |
                       +-------------------------------+
                       |        DataContext            |
                       +-------------------------------+
                               /               \
                              /                 \
             +---------------------+         +--------------------+
             | BacktestDataContext |         |  LiveDataContext   |
             | (과거 데이터 조회)  |         | (실시간 API 조회)  |
             +---------------------+         +--------------------+
                       |
                       V
    +--------------------------------+
    |        BacktestExecutor        |
    | - 시간 시뮬레이션              |
    | - 가상 거래 실행 (수수료 모델) |
    +--------------------------------+

```

                               +-----------------+
                               | Strategy Logic  |  (✨ 공통 핵심 코드)
                               | (신호 생성)     |
                               +-----------------+
                                       ^
                                       |
                                       |
                       +-------------------------------+
                       |        DataContext            |
                       +-------------------------------+
                               /               \
                              /                 \
             +---------------------+         +--------------------+
             | BacktestDataContext |         |  LiveDataContext   |
             | (과거 데이터 조회)  |         | (실시간 API 조회)  |
             +---------------------+         +--------------------+
                       |
                       V
    +--------------------------------+
    |          LiveExecutor          |
    | - 스케줄러에 의해 실행         |
    | - 실제 주문 실행 (Hantoo API)  |
    +--------------------------------+
```

- **`Strategy`**: 데이터 소스나 실행 방식에 관계없이, 오직 데이터를 받아 투자 신호를 생성하는 순수한 로직만 담고 있는 공통 코드입니다.
- **`DataContext`**: `Strategy`에 필요한 데이터를 제공하는 인터페이스입니다. 백테스트 시에는 DB의 과거 데이터를, 실거래 시에는 API를 통해 실시간 데이터를 제공합니다.
- **`Executor`**: `Strategy`가 생성한 신호를 받아 실제 행동으로 옮기는 실행기입니다. 백테스트 시에는 가상 거래를, 실거래 시에는 실제 주문을 실행합니다.

## 4. 주요 흐름 (Flows)

### 4.1. 백테스트 실행 흐름
1. **사용자**가 **웹 서비스**에서 특정 전략의 백테스트를 요청합니다.
2. **웹 서비스**는 `{'task': 'run_backtest', 'strategy_id': '...'}` 와 같은 작업 메시지를 **메시지 큐**에 전송합니다.
3. 대기하던 **백테스팅 워커**가 해당 메시지를 가져와, `BacktestExecutor`를 통해 시뮬레이션을 실행합니다.
4. **백테스팅 워커**는 결과를 **데이터베이스**에 저장합니다.
5. **사용자**는 **웹 서비스**를 통해 **데이터베이스**에 저장된 결과를 확인합니다.

### 4.2. 자동 거래 실행 흐름
1. **스케줄러**가 매 분마다 활성화된 모든 전략에 대한 평가 작업 메시지를 **메시지 큐**에 전송합니다.
2. **실거래 워커 풀**의 여러 워커들이 이 메시지들을 경쟁적으로 가져가 병렬로 처리하기 시작합니다.
3. 각 **워커**는 `LiveExecutor`를 통해 담당 전략을 평가하고, 거래 신호가 발생하면 증권사 API를 호출하여 실제 주문을 넣습니다.
4. 모든 거래 내역과 계좌 상태 변경은 **데이터베이스**에 기록됩니다.
5. **사용자**는 **웹 서비스**를 통해 이 운용 현황을 실시간으로 모니터링합니다.

```